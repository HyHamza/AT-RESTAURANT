<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA Cleanup Tool - AT Restaurant</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    .section h2 {
      color: #333;
      font-size: 18px;
      margin-bottom: 15px;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button.danger {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    button.success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 15px;
    }
    .log-entry {
      margin-bottom: 5px;
    }
    .log-entry.error {
      color: #ff6b6b;
    }
    .log-entry.success {
      color: #51cf66;
    }
    .log-entry.info {
      color: #74c0fc;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }
    .status.active {
      background: #d3f9d8;
      color: #2b8a3e;
    }
    .status.inactive {
      background: #ffe3e3;
      color: #c92a2a;
    }
    .info-box {
      background: #e7f5ff;
      border: 1px solid #74c0fc;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .info-box p {
      color: #1864ab;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß PWA Cleanup Tool</h1>
    <p class="subtitle">Clean up service workers and caches for dual PWA testing</p>

    <div class="info-box">
      <p><strong>‚ö†Ô∏è Important:</strong> Use this tool to completely reset PWA state before testing dual installation. This will unregister all service workers and clear all caches.</p>
    </div>

    <div class="section">
      <h2>üìä Current Status</h2>
      <div id="status">Checking...</div>
    </div>

    <div class="section">
      <h2>üßπ Cleanup Actions</h2>
      <button onclick="unregisterAllSW()">Unregister All Service Workers</button>
      <button onclick="clearAllCaches()">Clear All Caches</button>
      <button onclick="clearLocalStorage()">Clear LocalStorage</button>
      <button class="danger" onclick="fullCleanup()">üî• Full Cleanup (All)</button>
    </div>

    <div class="section">
      <h2>‚úÖ Testing Actions</h2>
      <button class="success" onclick="testUserApp()">Test User App</button>
      <button class="success" onclick="testAdminApp()">Test Admin App</button>
      <button onclick="checkManifests()">Check Manifests</button>
    </div>

    <div class="section">
      <h2>üìù Console Log</h2>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    async function checkStatus() {
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        const cacheNames = await caches.keys();
        
        let html = '<div>';
        html += `<p><strong>Service Workers:</strong> ${registrations.length} registered</p>`;
        
        registrations.forEach(reg => {
          const url = reg.active?.scriptURL || reg.installing?.scriptURL || reg.waiting?.scriptURL || 'Unknown';
          const scope = reg.scope;
          const state = reg.active ? 'active' : reg.installing ? 'installing' : 'waiting';
          html += `<p style="margin-left: 20px; font-size: 13px;">‚Ä¢ ${url}<br>  Scope: ${scope} <span class="status ${state === 'active' ? 'active' : 'inactive'}">${state}</span></p>`;
        });
        
        html += `<p style="margin-top: 15px;"><strong>Caches:</strong> ${cacheNames.length} cache(s)</p>`;
        cacheNames.forEach(name => {
          html += `<p style="margin-left: 20px; font-size: 13px;">‚Ä¢ ${name}</p>`;
        });
        
        const lsKeys = Object.keys(localStorage).filter(k => k.includes('pwa'));
        html += `<p style="margin-top: 15px;"><strong>LocalStorage PWA Keys:</strong> ${lsKeys.length}</p>`;
        lsKeys.forEach(key => {
          html += `<p style="margin-left: 20px; font-size: 13px;">‚Ä¢ ${key}</p>`;
        });
        
        html += '</div>';
        statusEl.innerHTML = html;
        
        log(`Status checked: ${registrations.length} SW, ${cacheNames.length} caches`, 'info');
      } catch (error) {
        log(`Error checking status: ${error.message}`, 'error');
      }
    }

    async function unregisterAllSW() {
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        log(`Found ${registrations.length} service worker(s) to unregister`, 'info');
        
        for (const registration of registrations) {
          const url = registration.active?.scriptURL || 'Unknown';
          await registration.unregister();
          log(`‚úì Unregistered: ${url}`, 'success');
        }
        
        log('All service workers unregistered!', 'success');
        await checkStatus();
      } catch (error) {
        log(`Error unregistering service workers: ${error.message}`, 'error');
      }
    }

    async function clearAllCaches() {
      try {
        const cacheNames = await caches.keys();
        log(`Found ${cacheNames.length} cache(s) to delete`, 'info');
        
        for (const name of cacheNames) {
          await caches.delete(name);
          log(`‚úì Deleted cache: ${name}`, 'success');
        }
        
        log('All caches cleared!', 'success');
        await checkStatus();
      } catch (error) {
        log(`Error clearing caches: ${error.message}`, 'error');
      }
    }

    function clearLocalStorage() {
      try {
        const keys = Object.keys(localStorage).filter(k => k.includes('pwa'));
        log(`Found ${keys.length} PWA-related localStorage key(s)`, 'info');
        
        keys.forEach(key => {
          localStorage.removeItem(key);
          log(`‚úì Removed: ${key}`, 'success');
        });
        
        log('LocalStorage cleared!', 'success');
        checkStatus();
      } catch (error) {
        log(`Error clearing localStorage: ${error.message}`, 'error');
      }
    }

    async function fullCleanup() {
      log('üî• Starting full cleanup...', 'info');
      await unregisterAllSW();
      await clearAllCaches();
      clearLocalStorage();
      log('üéâ Full cleanup complete! Reload the page to start fresh.', 'success');
    }

    async function testUserApp() {
      log('Testing User App...', 'info');
      try {
        const response = await fetch('/manifest.json');
        const manifest = await response.json();
        log(`User Manifest ID: ${manifest.id}`, manifest.id === 'com.atrestaurant.user' ? 'success' : 'error');
        log(`User Start URL: ${manifest.start_url}`, 'info');
        log(`User Scope: ${manifest.scope}`, 'info');
        log(`User Name: ${manifest.name}`, 'info');
        window.open('/', '_blank');
      } catch (error) {
        log(`Error testing user app: ${error.message}`, 'error');
      }
    }

    async function testAdminApp() {
      log('Testing Admin App...', 'info');
      try {
        const response = await fetch('/admin-manifest.json');
        const manifest = await response.json();
        log(`Admin Manifest ID: ${manifest.id}`, manifest.id === 'com.atrestaurant.admin' ? 'success' : 'error');
        log(`Admin Start URL: ${manifest.start_url}`, 'info');
        log(`Admin Scope: ${manifest.scope}`, 'info');
        log(`Admin Name: ${manifest.name}`, 'info');
        window.open('/admin', '_blank');
      } catch (error) {
        log(`Error testing admin app: ${error.message}`, 'error');
      }
    }

    async function checkManifests() {
      log('Checking both manifests...', 'info');
      try {
        const userRes = await fetch('/manifest.json');
        const userManifest = await userRes.json();
        
        const adminRes = await fetch('/admin-manifest.json');
        const adminManifest = await adminRes.json();
        
        log('--- User Manifest ---', 'info');
        log(`ID: ${userManifest.id}`, userManifest.id === 'com.atrestaurant.user' ? 'success' : 'error');
        log(`Name: ${userManifest.name}`, 'info');
        log(`Start URL: ${userManifest.start_url}`, 'info');
        log(`Scope: ${userManifest.scope}`, 'info');
        
        log('--- Admin Manifest ---', 'info');
        log(`ID: ${adminManifest.id}`, adminManifest.id === 'com.atrestaurant.admin' ? 'success' : 'error');
        log(`Name: ${adminManifest.name}`, 'info');
        log(`Start URL: ${adminManifest.start_url}`, 'info');
        log(`Scope: ${adminManifest.scope}`, 'info');
        
        if (userManifest.id === adminManifest.id) {
          log('‚ùå ERROR: Both manifests have the same ID!', 'error');
        } else {
          log('‚úÖ Manifests have different IDs - Good!', 'success');
        }
      } catch (error) {
        log(`Error checking manifests: ${error.message}`, 'error');
      }
    }

    // Initial status check
    checkStatus();
    log('PWA Cleanup Tool loaded', 'success');
  </script>
</body>
</html>
