<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA Debug Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .status {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #0051cc;
    }
    .error { color: #e00; }
    .success { color: #0a0; }
    .info { color: #00a; }
  </style>
</head>
<body>
  <h1>üîç PWA Debug Test</h1>
  
  <div class="status">
    <h2>Service Worker Status</h2>
    <div id="sw-status">Checking...</div>
  </div>

  <div class="status">
    <h2>Manifest Status</h2>
    <div id="manifest-status">Checking...</div>
  </div>

  <div class="status">
    <h2>Actions</h2>
    <button onclick="checkSW()">Check Service Workers</button>
    <button onclick="checkManifests()">Check Manifests</button>
    <button onclick="unregisterAll()">Unregister All SWs</button>
    <button onclick="clearCaches()">Clear All Caches</button>
    <button onclick="testHomepage()">Test Homepage</button>
  </div>

  <div class="status">
    <h2>Console</h2>
    <div id="console" style="font-family: monospace; font-size: 12px;"></div>
  </div>

  <script>
    function log(msg, type = 'info') {
      const console = document.getElementById('console');
      const line = document.createElement('div');
      line.className = type;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      console.appendChild(line);
      console.scrollTop = console.scrollHeight;
    }

    async function checkSW() {
      log('Checking service workers...', 'info');
      const swStatus = document.getElementById('sw-status');
      
      if (!('serviceWorker' in navigator)) {
        swStatus.innerHTML = '<span class="error">‚ùå Service Workers not supported</span>';
        log('Service Workers not supported', 'error');
        return;
      }

      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        log(`Found ${registrations.length} service worker(s)`, 'success');
        
        let html = `<p class="success">‚úÖ Found ${registrations.length} service worker(s)</p>`;
        
        registrations.forEach((reg, i) => {
          const url = reg.active?.scriptURL || reg.installing?.scriptURL || 'Unknown';
          const scope = reg.scope;
          const state = reg.active ? 'active' : reg.installing ? 'installing' : 'waiting';
          
          html += `<div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px;">`;
          html += `<strong>SW ${i + 1}:</strong><br>`;
          html += `URL: ${url}<br>`;
          html += `Scope: ${scope}<br>`;
          html += `State: <span class="${state === 'active' ? 'success' : 'info'}">${state}</span>`;
          html += `</div>`;
          
          log(`SW ${i + 1}: ${url} (${scope}) - ${state}`, 'info');
        });
        
        swStatus.innerHTML = html;
      } catch (error) {
        swStatus.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
        log(`Error checking SWs: ${error.message}`, 'error');
      }
    }

    async function checkManifests() {
      log('Checking manifests...', 'info');
      const manifestStatus = document.getElementById('manifest-status');
      let html = '';
      
      try {
        // Check user manifest
        const userRes = await fetch('/manifest.json');
        const userManifest = await userRes.json();
        
        html += '<div style="margin-bottom: 15px;"><strong>User Manifest:</strong><br>';
        html += `ID: <span class="${userManifest.id === 'com.atrestaurant.user' ? 'success' : 'error'}">${userManifest.id}</span><br>`;
        html += `Name: ${userManifest.name}<br>`;
        html += `Start URL: ${userManifest.start_url}<br>`;
        html += `Scope: ${userManifest.scope}</div>`;
        
        log(`User manifest ID: ${userManifest.id}`, userManifest.id === 'com.atrestaurant.user' ? 'success' : 'error');
        
        // Check admin manifest
        const adminRes = await fetch('/admin-manifest.json');
        const adminManifest = await adminRes.json();
        
        html += '<div><strong>Admin Manifest:</strong><br>';
        html += `ID: <span class="${adminManifest.id === 'com.atrestaurant.admin' ? 'success' : 'error'}">${adminManifest.id}</span><br>`;
        html += `Name: ${adminManifest.name}<br>`;
        html += `Start URL: ${adminManifest.start_url}<br>`;
        html += `Scope: ${adminManifest.scope}</div>`;
        
        log(`Admin manifest ID: ${adminManifest.id}`, adminManifest.id === 'com.atrestaurant.admin' ? 'success' : 'error');
        
        if (userManifest.id === adminManifest.id) {
          html += '<p class="error">‚ö†Ô∏è WARNING: Both manifests have the same ID!</p>';
          log('WARNING: Manifests have same ID!', 'error');
        } else {
          html += '<p class="success">‚úÖ Manifests have different IDs</p>';
          log('Manifests have different IDs - Good!', 'success');
        }
        
        manifestStatus.innerHTML = html;
      } catch (error) {
        manifestStatus.innerHTML = `<span class="error">‚ùå Error: ${error.message}</span>`;
        log(`Error checking manifests: ${error.message}`, 'error');
      }
    }

    async function unregisterAll() {
      log('Unregistering all service workers...', 'info');
      try {
        const registrations = await navigator.serviceWorker.getRegistrations();
        for (const reg of registrations) {
          await reg.unregister();
          log(`Unregistered: ${reg.scope}`, 'success');
        }
        log('All service workers unregistered!', 'success');
        await checkSW();
      } catch (error) {
        log(`Error unregistering: ${error.message}`, 'error');
      }
    }

    async function clearCaches() {
      log('Clearing all caches...', 'info');
      try {
        const names = await caches.keys();
        for (const name of names) {
          await caches.delete(name);
          log(`Deleted cache: ${name}`, 'success');
        }
        log('All caches cleared!', 'success');
      } catch (error) {
        log(`Error clearing caches: ${error.message}`, 'error');
      }
    }

    function testHomepage() {
      log('Opening homepage in new tab...', 'info');
      window.open('/', '_blank');
    }

    // Auto-check on load
    window.addEventListener('load', () => {
      log('Page loaded, running checks...', 'info');
      checkSW();
      checkManifests();
    });
  </script>
</body>
</html>
