<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Service Worker Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .status {
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .success { border-left: 4px solid #22c55e; }
    .error { border-left: 4px solid #ef4444; }
    .warning { border-left: 4px solid #f59e0b; }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      background: #e11b70;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #c01560; }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
    }
    .log-entry {
      padding: 8px;
      margin: 4px 0;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .log-info { background: #dbeafe; }
    .log-success { background: #dcfce7; }
    .log-error { background: #fee2e2; }
  </style>
</head>
<body>
  <h1>üîß Service Worker Diagnostic Tool</h1>
  
  <div id="status" class="status warning">
    <h3>Checking Service Worker status...</h3>
  </div>

  <div class="status">
    <h3>Actions</h3>
    <button onclick="checkStatus()">üîÑ Refresh Status</button>
    <button onclick="unregisterSW()">‚ùå Unregister SW</button>
    <button onclick="clearCaches()">üóëÔ∏è Clear All Caches</button>
    <button onclick="testFetch()">üåê Test Fetch</button>
    <button onclick="clearLogs()">üßπ Clear Logs</button>
  </div>

  <div class="status">
    <h3>Live Logs</h3>
    <div id="logs"></div>
  </div>

  <script>
    const statusDiv = document.getElementById('status');
    const logsDiv = document.getElementById('logs');

    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logsDiv.insertBefore(entry, logsDiv.firstChild);
      console.log(message);
    }

    function clearLogs() {
      logsDiv.innerHTML = '';
      log('Logs cleared', 'info');
    }

    async function checkStatus() {
      log('Checking Service Worker status...', 'info');
      
      if (!('serviceWorker' in navigator)) {
        statusDiv.className = 'status error';
        statusDiv.innerHTML = '<h3>‚ùå Service Workers Not Supported</h3><p>Your browser does not support Service Workers.</p>';
        log('Service Workers not supported', 'error');
        return;
      }

      try {
        const registration = await navigator.serviceWorker.getRegistration();
        
        if (!registration) {
          statusDiv.className = 'status warning';
          statusDiv.innerHTML = '<h3>‚ö†Ô∏è No Service Worker Registered</h3><p>No active service worker found.</p>';
          log('No service worker registered', 'info');
          return;
        }

        const controller = navigator.serviceWorker.controller;
        const active = registration.active;
        const installing = registration.installing;
        const waiting = registration.waiting;

        let html = '<h3>‚úÖ Service Worker Status</h3>';
        html += `<p><strong>Scope:</strong> ${registration.scope}</p>`;
        html += `<p><strong>Update Via Cache:</strong> ${registration.updateViaCache}</p>`;
        
        if (controller) {
          html += `<p><strong>Controller:</strong> Active (${controller.scriptURL})</p>`;
          log('Controller active: ' + controller.scriptURL, 'success');
        } else {
          html += '<p><strong>Controller:</strong> None (page not controlled)</p>';
          log('No controller - page not controlled', 'warning');
        }

        if (active) {
          html += `<p><strong>Active:</strong> ${active.state} (${active.scriptURL})</p>`;
          log('Active worker: ' + active.state, 'success');
        }
        if (installing) {
          html += `<p><strong>Installing:</strong> ${installing.state}</p>`;
          log('Installing worker: ' + installing.state, 'info');
        }
        if (waiting) {
          html += `<p><strong>Waiting:</strong> ${waiting.state} (‚ö†Ô∏è Update pending!)</p>`;
          log('Waiting worker detected - update pending!', 'error');
        }

        // Check caches
        const cacheNames = await caches.keys();
        html += `<p><strong>Caches:</strong> ${cacheNames.length} cache(s)</p>`;
        html += '<pre>' + JSON.stringify(cacheNames, null, 2) + '</pre>';
        log(`Found ${cacheNames.length} caches: ${cacheNames.join(', ')}`, 'info');

        // Check global flags
        html += '<h4>Registration Flags</h4>';
        html += `<p><strong>window.__SW_REGISTERED__:</strong> ${window.__SW_REGISTERED__ || false}</p>`;
        html += `<p><strong>window.__SW_REGISTERING__:</strong> ${window.__SW_REGISTERING__ || false}</p>`;

        statusDiv.className = 'status success';
        statusDiv.innerHTML = html;
        log('Status check complete', 'success');

      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.innerHTML = `<h3>‚ùå Error</h3><p>${error.message}</p>`;
        log('Error checking status: ' + error.message, 'error');
      }
    }

    async function unregisterSW() {
      log('Attempting to unregister service worker...', 'info');
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration) {
          await registration.unregister();
          window.__SW_REGISTERED__ = false;
          window.__SW_REGISTERING__ = false;
          log('Service worker unregistered successfully', 'success');
          alert('Service Worker unregistered! Reload the page to re-register.');
        } else {
          log('No service worker to unregister', 'info');
          alert('No Service Worker found to unregister.');
        }
        checkStatus();
      } catch (error) {
        log('Error unregistering: ' + error.message, 'error');
        alert('Error: ' + error.message);
      }
    }

    async function clearCaches() {
      log('Clearing all caches...', 'info');
      try {
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        log(`Cleared ${cacheNames.length} caches`, 'success');
        alert(`Cleared ${cacheNames.length} cache(s)!`);
        checkStatus();
      } catch (error) {
        log('Error clearing caches: ' + error.message, 'error');
        alert('Error: ' + error.message);
      }
    }

    async function testFetch() {
      log('Testing fetch through service worker...', 'info');
      try {
        const response = await fetch('/favicon.ico');
        const fromSW = response.headers.get('x-from-sw') || 'unknown';
        log(`Fetch test: ${response.status} ${response.statusText} (from SW: ${fromSW})`, 'success');
        alert(`Fetch successful!\nStatus: ${response.status}\nFrom SW: ${fromSW}`);
      } catch (error) {
        log('Fetch test failed: ' + error.message, 'error');
        alert('Fetch failed: ' + error.message);
      }
    }

    // Listen for SW messages
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        log('Message from SW: ' + JSON.stringify(event.data), 'info');
      });

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        log('Controller changed! New SW activated.', 'success');
        checkStatus();
      });
    }

    // Auto-check on load
    window.addEventListener('load', () => {
      log('Page loaded, checking status...', 'info');
      checkStatus();
    });
  </script>
</body>
</html>
